<!DOCTYPE html>
<html lang="zh-cn">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>CMU15445学习笔记 - M-071的甲板</title>
  
    <link rel="shortcut icon" href="/images/favicon.png">
  
  
    <link rel='manifest' href='/images/manifest.json'>
  

  
  
  
  <meta property="og:title" content="CMU15445学习笔记 - M-071的甲板" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="https://wsyunine.github.io/2024/12/09/CMU15445-learning-note/index.html" />
  
  <meta property="og:image" content="/images/CMU15445.webp" />
  
  <meta property="og:article:published_time" content="2024-12-08T16:58:39.000Z" />
  
  <meta property="og:article:author" content="wsy_jim" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="light/dark/auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">M-071的甲板</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">主页</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/wsyunine" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/wsy_jim" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item" href="/tags">Tags</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/公开课/">公开课</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>December</span>
            <span>9,</span>
            <span>2024</span>
        </div>
        

        <h1 class="title">CMU15445学习笔记</h1>
    </div>

    <div class="divider"></div>

    <div class="content ">
        <p>学一学CMU的15445，<a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/fall2024/">课程地址</a></p>
<span id="more"></span>
<h2 id="project-0---c-primer">Project #0 - C++ Primer</h2>
<h3 id="c-bootcamp">C++ Bootcamp</h3>
<p>主要针对 C++17 特性，共 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(500,0)"></path></g></g></g></svg></mjx-container></span> 个文件。</p>
<ol type="1">
<li><p>references.cpp</p>
<p>有关引用（别名），函数传引用</p></li>
<li><p>move_semantics.cpp</p>
<p>有关移动语义和右值引用</p>
<ul>
<li><p>lvalue（左值）：refer to 内存中某个有权限访问的区域的对象</p>
<p>rvalue（右值）：非左值的值，数据位于的区域没有权限访问（字面常量）或者没有必要访问（匿名对象），包括<strong>将亡值</strong>和<strong>纯右值</strong></p>
<p>赋值语句中等号左边的必须是左值，右边的随便</p></li>
<li><p>左值引用（&amp;）和右值引用（&amp;&amp;）都必须立即初始化，右值引用可以<strong>通过移动的方式在浅拷贝的情况下保证拷贝的安全性</strong>，在设计和实现类时，对于需要动态申请大量资源的类，应该设计右值引用的拷贝构造函数和赋值函数，以提高应用程序的效率，具体 3. 中有讲</p></li>
<li><p>std::move() 方法可以将左值转换为右值，即将亡值，方便使用移动语义，需要 <code>&lt;utility&gt;</code> 头文件</p></li>
</ul></li>
<li><p>move_constructors.cpp</p>
<p>有关应用移动语义的拷贝构造函数和赋值重载函数</p>
<p>在类定义中删除左值引用的拷贝构造函数和赋值重载函数，意味着实例化后就不再允许被复制，防止双重删除或者内存泄露</p>
<p>References：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/677643121">C++11右值引用|移动语义|完美转发|巨巨巨详细</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/620583555">C++|左值、右值、将亡值|谈谈我对它们的深入理解</a></li>
</ul></li>
<li><p>templated_functions.cpp</p>
<p>有关模板函数</p>
<p>注意模板参数不一定要是 <code>class</code> 或者 <code>typename</code>，也可以是别的，但没必要</p></li>
<li><p>templated_classes.cpp</p>
<p>有关模板类</p></li>
<li><p>wrapper_class.cpp</p>
<p>有关包装类</p>
<ul>
<li>RAII（Resource Acquisition is Initialization）：一个实例化管理一个资源，防止双重删除或内存泄露</li>
<li>使用移动语义</li>
</ul></li>
<li><p>iterator.cpp</p>
<p>有关迭代器，实现了一个双向链表（DLL）及其迭代器</p></li>
<li><p>namespaces.cpp</p>
<p>有关命名空间</p></li>
<li><p>vectors.cpp</p>
<p>有关动态数组</p>
<p><code>std::remove_if()</code> 不能删除元素，只能将元素移到末尾，配合 <code>erase()</code> 函数才能删掉</p>
<p><code>emplace_back()</code> 比 <code>push_back()</code> 稍快</p></li>
<li><p>sets.cpp</p>
<p>有关集合</p>
<p><code>count()</code> 函数</p></li>
<li><p>unordered_maps.cpp</p>
<p>有关映射</p>
<p><code>count()</code> 函数</p></li>
<li><p>auto.cpp</p>
<p>有关 <code>auto</code> 类型使用</p></li>
<li><p>unique_ptr.cpp</p>
<p>有关智能指针类型 <code>unique_ptr</code> 使用</p>
<ul>
<li><p>需要 <code>&lt;memory&gt;</code> 头文件</p></li>
<li><p><code>unique_ptr</code> 保留对象的唯一所有权，没有两个 <code>unique_ptr</code> 指针指向同一个对象</p></li>
<li><p>初始化</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用make_unique&lt;&gt;()方法初始化，调用的构造函数是&lt;&gt;类型的构造函数</span></span><br><span class="line">std::unique_ptr&lt;Point&gt; u = std::<span class="built_in">make_unique</span>&lt;Point&gt;();</span><br></pre></td></tr></table></figure></p></li>
<li><p>可以通过移动语义转移所有权</p></li>
</ul></li>
<li><p>shared_ptr.cpp</p>
<p>有关智能指针类型 <code>shared_ptr</code> 使用</p>
<ul>
<li><p>需要 <code>&lt;memory&gt;</code> 头文件</p></li>
<li><p>可以有多个 <code>shared_ptr</code> 指针指向同一个对象</p></li>
<li><p>初始化</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用make_shared&lt;&gt;()方法初始化，调用的构造函数是&lt;&gt;类型的构造函数</span></span><br><span class="line">std::shared_ptr&lt;Point&gt; u = std::<span class="built_in">make_shared</span>&lt;Point&gt;();</span><br></pre></td></tr></table></figure></p></li>
<li><p>通过 <code>use_count()</code> 方法可以得到有多少个指针指向同个对象</p></li>
<li><p>可以通过移动语义转移所有权</p></li>
</ul></li>
<li><p>mutex.cpp</p>
<p>有关互斥锁</p>
<ul>
<li>同步原语（Synchronization Primitives）是用于支持此多线程环境下线程同步的工具和机制。这些源于主要用于管理线程之间对共享资源的访问，防止数据竞争和保证线程安全</li>
<li><code>std::mutex</code> 提供独占锁，确保同一时间只有一个线程可以获得互斥量，不可复制，不可移动</li>
<li>互斥量状态：
<ul>
<li>解锁状态意味着共享资源可用</li>
<li>加锁状态意味着共享资源不可用</li>
</ul></li>
<li>需要 <code>&lt;mutex&gt;</code> 和 <code>&lt;thread&gt;</code> 头文件</li>
<li><code>lock()</code> 锁住互斥量，<code>unlock()</code> 解锁互斥量，<code>try_lock()</code> 尝试锁住互斥量</li>
<li>被阻塞</li>
</ul>
<p>References：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_74811378/article/details/144144933">C++多线程——互斥量mutex</a></li>
</ul></li>
<li><p>scoped_lock.cpp</p>
<p>有关多个互斥量的管理</p>
<ul>
<li><p>需要 <code>&lt;mutex&gt;</code> 和 <code>&lt;thread&gt;</code> 头文件</p></li>
<li><p>当创建一个 <code>std::scoped_lock</code> 对象时，它尝试取得其所给互斥量的所有权。当控制权离开创建 <code>scoped_lock</code> 对象的作用域时，<code>scoped_lock</code> 会被析构，互斥量随之被释放。如果给定了多个互斥量，将使用避免死锁的算法，类似于 <code>std::lock</code></p></li>
<li><p>是一个 RAII 风格的类</p></li>
<li><p><code>scoped_lock</code> 类不可复制，不可移动</p></li>
</ul>
<p>References：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21438461/article/details/135670987">【C++ 17 新特性 互斥锁】std::scoped_lock 的使用，管理多个互斥量</a></li>
</ul></li>
<li><p>condition_variable.cpp</p>
<p>有关条件变量</p>
<ul>
<li>需要 <code>&lt;condition_variable&gt;</code> 头文件</li>
<li>功能：
<ul>
<li>拥有条件变量的线程获取互斥量</li>
<li>循环检查某个条件，如果条件不满足则阻塞直到满足；如果满足则向下执行</li>
<li>某个线程满足条件执行完之后调用 <code>notify_one</code> 或 <code>notify_all</code> 唤醒一个或所有等待线程</li>
</ul></li>
<li><code>wait()</code> 第一个参数必须用 <code>unique_lock</code></li>
<li><code>unique_lock</code> 不能复制，可以移动</li>
</ul>
<p>References：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/599172163">C++11条件变量condition_variable详解</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013043408/article/details/138437356">【C++】独占互斥锁（unique_lock）</a></li>
</ul></li>
<li><p>rwlock.cpp</p>
<p>有关读写器锁的用法</p>
<ul>
<li>用 <code>std::shared_mutex</code>、<code>std::shared_lock</code> 和 <code>std::unique_lock</code></li>
<li>需要 <code>&lt;shared_mutex&gt;</code></li>
<li><code>std::mutex</code> 和 <code>std::shared_mutex</code> 的区别：
<ul>
<li><code>std::mutex</code> 提供独占访问，同一时间只能有一个线程持有该类型的锁</li>
<li><code>std::shared_mutex</code> 提供共享访问和独占访问，允许多个线程通过持有 <code>std::shared_lock</code> 共享锁来只读访问，允许一个线程持有 <code>std::unique_lock</code> 独占锁来进行写操作，但是共享锁和独占锁不能同时存在，互斥</li>
<li><code>std::shared_mutex</code> 更适用于读多写少的场景</li>
</ul></li>
</ul></li>
<li><p>s24_my_ptr.cpp</p>
<p>实现了一个 <code>std::unique_pointer&lt;T&gt;</code> 类</p>
<ul>
<li>使用原始指针类型，很可能会出现内存泄露，二次释放，释放后访问的问题</li>
<li>RAII 的好处</li>
<li><code>smart_generator&lt;int&gt;()</code> 和 <code>dumb_generator&lt;int&gt;()</code> 的区别</li>
</ul></li>
</ol>
<h3 id="hyperloglog-算法">HyperLogLog 算法</h3>
<p>HyperLogLog 算法是一种用于估计大规模数据集基数的随机化算法</p>
<p>基数（cardinality）：集合中不同元素的个数</p>
<p>时间复杂度：</p>
<ul>
<li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></span> 插入</li>
<li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></span> 查询</li>
<li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></span> 合并两个计数器</li>
</ul>
<p>基本原理：</p>
<p>基于抛硬币的原理，由连续抛硬币出现正面的概率来估算一共抛硬币的次数</p>
<p>相似的，我们可以将主键进行哈希，得到一个 01 串，通过统计从第零位开始连续的 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></svg></mjx-container></span> 的个数的最大值来估算基数</p>
<p>为了减小偶然性，可以设置 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.986ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 878 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container></span> 个寄存器，分别统计连续 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></svg></mjx-container></span> 的个数的最大值，取01串的前 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></svg></mjx-container></span> 高位作为寄存器编号，分别在各自寄存器内更新，最后综合起来计算答案即可</p>
<p>Presto 的实现其实就是为了减小寄存器（dense_bucket_）的大小，将超出寄存器表示范围的部分存到另一个 unordered_map（overflow_bucket_）中，因为有时某些寄存器根本没有用到，无用空间过多</p>
<p>代码并不难写，主要是弄懂怎么调试……使用 <code>bustub</code> 已经配置好的 <code>google test</code> 调试各个函数就好</p>
<p><img src="https://p.ipic.vip/9v9etd.png" alt="image-20250110153509098" style="zoom:70%;"></p>
<p>上图是我瞎写了一通以后拿的分数，看了看 results 发现答案没问题，但是存在内存泄露，因为我寄存器是用动态分配空间的数组实现的，这就需要在类析构的时候 <code>free()</code> 掉，写了一个析构函数就过了，如果使用 STL​ 中的 <code>vector</code> 就不会出现内存泄露，因为 C++ 的 STL 都遵循 RAII 的原则</p>
<p><img src="https://p.ipic.vip/asq6ia.png" alt="image-20250110162252511" style="zoom:70%;"></p>
<p>还有一个比较蛋疼的地方就是格式问题，格式不对就给判成 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></svg></mjx-container></span> 分，需要注意一下</p>
<hr>
<h2 id="lecture-01---relational-model-algebra">Lecture #01 - Relational Model &amp; Algebra</h2>
<p><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/fall2024/notes/01-relationalmodel.pdf">Notes</a></p>
<p>一些有关关系型数据库的概念，一些关系源语</p>
<hr>
<h2 id="lecture-02---modern-sql">Lecture #02 - Modern SQL</h2>
<p><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/fall2024/notes/02-modernsql.pdf">Notes</a></p>
<p>彩蛋：Andy 教授在课上播放了在若干年前他教他的女儿写第一条 SQL 查询语句的视频，太可爱了</p>
<p><img src="https://p.ipic.vip/bsbxw9.png" alt="image-20250110223425109" style="zoom:50%;"></p>
<p>不同 DBMS 所使用的 SQL 语法有所不同，但最后都要有分号！！！</p>
<p>补充一些之前没有学习到并且很重要的 SQL 语句</p>
<ul>
<li><p>窗口函数（Window Function）是 SQL 中一种可以在查询结果中对一组行进行计算的函数。与聚合函数（如 SUM、AVG、COUNT 等）不同，聚合函数会对一组行返回一个单一的值，而窗口函数可以对每一行单独进行计算，并且仍然保留查询结果中的所有行（MySQL 不支持）</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 列<span class="number">1</span>, 列<span class="number">2</span>, </span><br><span class="line">       窗口函数() <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> 列名 </span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> 列名 </span><br><span class="line">           <span class="keyword">ROWS</span><span class="operator">/</span><span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> </span><br><span class="line">           UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">       )</span><br><span class="line"><span class="keyword">FROM</span> 表名;</span><br></pre></td></tr></table></figure></p>
<ol type="1">
<li>窗口函数：指你使用的函数（如 <code>ROW_NUMBER()</code>、<code>RANK()</code>、<code>SUM()</code>、<code>AVG()</code>、<code>LEAD()</code>、<code>LAG()</code> 等）</li>
<li><code>OVER()</code> 子句：定义了窗口，也就是窗口函数操作的行集 - <code>PARTITION BY</code>：用来将结果集分成不同的分区，每个分区会单独计算窗口函数。类似于 <code>GROUP BY</code> - <code>ORDER BY</code>：定义了每个分区中行的排序，通常是需要的，特别是对于 <code>ROW_NUMBER()</code>、<code>RANK()</code> 这样的函数 - <code>ROWS/RANGE</code>：定义了窗口框架，决定哪些行会被包含在每次计算中</li>
</ol></li>
<li><p>横向查询（Lateral Join）是 SQL 中的一种连接类型，它允许子查询引用来自外部查询的列。具体来说，LATERAL 关键字使得子查询在每一行外部查询的结果集时可以“横向”展开，从而为每一行产生不同的结果</p>
<p>简单来说，LATERAL 使得子查询在查询执行过程中能够访问外部查询的每一行数据，而不像普通的子查询那样仅仅返回一个固定结果</p></li>
<li><p>Common Table Expressions (CTEs) 是 SQL 中的一种构造方式，它允许你定义一个临时结果集（类似于视图），并在查询的其他部分引用它。CTE 提高了查询的可读性和可维护性，特别是在处理复杂的查询时。CTE 是通过使用 WITH 关键字来定义的，它通常用于临时计算、递归查询或者分步解决复杂查询的问题</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> cte_name <span class="keyword">AS</span> (</span><br><span class="line">    <span class="comment">-- 子查询</span></span><br><span class="line">    <span class="keyword">SELECT</span> column1, column2</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">table</span></span><br><span class="line">    <span class="keyword">WHERE</span> <span class="keyword">condition</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> cte_name;</span><br></pre></td></tr></table></figure></p></li>
</ul>
<hr>
<h2 id="homework-1---sql">Homework #1 - SQL</h2>
<p>要求在 <code>SQLite</code> 和 <code>Duckdb</code> 上编写一些查询代码并执行，还是有些难度的</p>
<ol type="1">
<li><p>查询至少得过一枚奖牌的教练（即相同国家和项目的运动员或队伍得过至少一枚奖牌的教练），并按以奖牌数为第一关键字降序、以名字为第二关键字字典序排序</p>
<p>分析：</p>
<p>首先我们要找出教练的国家和项目</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ch.name, ch.country_code, ch.discipline <span class="keyword">from</span> coaches <span class="keyword">as</span> ch;</span><br></pre></td></tr></table></figure></p>
<p>然后要找出奖牌的项目和胜者 code</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> m.discipline, m.winner_code <span class="keyword">from</span> medals <span class="keyword">as</span> m;</span><br></pre></td></tr></table></figure></p>
<p>将两者通过 discipline 结合</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ch.name <span class="keyword">as</span> ch_name, ch.country_code <span class="keyword">as</span> ch_ct, m.winner_code <span class="keyword">as</span> win <span class="keyword">from</span> coaches <span class="keyword">as</span> ch, medals <span class="keyword">as</span> m <span class="keyword">where</span> ch.discipline <span class="operator">=</span> m.discipline;</span><br></pre></td></tr></table></figure></p>
<p>先找运动员</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> tmp.ch_name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> ch.name <span class="keyword">as</span> ch_name, ch.country_code <span class="keyword">as</span> ch_ct, m.winner_code <span class="keyword">as</span> win <span class="keyword">from</span> coaches <span class="keyword">as</span> ch, medals <span class="keyword">as</span> m <span class="keyword">where</span> ch.discipline <span class="operator">=</span> m.discipline) <span class="keyword">as</span> tmp, athletes <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> tmp.win <span class="operator">=</span> a.code <span class="keyword">and</span> tmp.ch_ct <span class="operator">=</span> a.country_code</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> tmp.ch_name</span><br><span class="line"><span class="keyword">having</span> c <span class="operator">&gt;</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>再找队伍</p>
<p>这个地方需要注意，队伍 relation 中一个 tuple 表示一个队员，所以一个队伍可能会有很多 tuple，我们需要的只是 code 和 country_code，所以需要子查询</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> code, country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code;</span><br></pre></td></tr></table></figure></p>
<p>一个很有意思的事情，在 <code>SQLite</code> 中，上面的语句是可以正常执行的，但是在 <code>Duckdb</code> 中会报错，因为机器不知道 <code>code</code> 和 <code>country_code</code> 之间存在关系，即不同的 <code>code</code> 对应不同的 <code>country_code</code>，所以若只以 <code>code</code> 分组会导致机器不知道要拿组内哪个 <code>country_code</code> 的值来输出，产生不准确的查询，要么也以 <code>country_code</code> 分组，要么加 <code>any_value()</code> 函数，表示随意取一个值，但是在 <code>SQLite</code> 中，没有这个函数</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> code, any_value(country_code) <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> tmp.ch_name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> ch.name <span class="keyword">as</span> ch_name, ch.country_code <span class="keyword">as</span> ch_ct, m.winner_code <span class="keyword">as</span> win <span class="keyword">from</span> coaches <span class="keyword">as</span> ch, medals <span class="keyword">as</span> m <span class="keyword">where</span> ch.discipline <span class="operator">=</span> m.discipline) <span class="keyword">as</span> tmp, (<span class="keyword">select</span> code, country_code <span class="keyword">as</span> ct <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code) <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">where</span> tmp.win <span class="operator">=</span> t.code <span class="keyword">and</span> tmp.ch_ct <span class="operator">=</span> t.ct</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> tmp.ch_name</span><br><span class="line"><span class="keyword">having</span> c <span class="operator">&gt;</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>最后排序（丑的一批）</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQLite</span></span><br><span class="line"><span class="keyword">select</span> q1.name, <span class="built_in">sum</span>(c) <span class="keyword">as</span> s</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(</span><br><span class="line">        <span class="keyword">select</span> tmp.ch_name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> (<span class="keyword">select</span> ch.name <span class="keyword">as</span> ch_name, ch.country_code <span class="keyword">as</span> ch_ct, m.winner_code <span class="keyword">as</span> win <span class="keyword">from</span> coaches <span class="keyword">as</span> ch, medals <span class="keyword">as</span> m <span class="keyword">where</span> ch.discipline <span class="operator">=</span> m.discipline) <span class="keyword">as</span> tmp, athletes <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">where</span> tmp.win <span class="operator">=</span> a.code <span class="keyword">and</span> tmp.ch_ct <span class="operator">=</span> a.country_code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> tmp.ch_name</span><br><span class="line">        <span class="keyword">having</span> c <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> tmp.ch_name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> (<span class="keyword">select</span> ch.name <span class="keyword">as</span> ch_name, ch.country_code <span class="keyword">as</span> ch_ct, m.winner_code <span class="keyword">as</span> win <span class="keyword">from</span> coaches <span class="keyword">as</span> ch, medals <span class="keyword">as</span> m <span class="keyword">where</span> ch.discipline <span class="operator">=</span> m.discipline) <span class="keyword">as</span> tmp, (<span class="keyword">select</span> code, country_code <span class="keyword">as</span> ct <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code) <span class="keyword">as</span> t</span><br><span class="line">        <span class="keyword">where</span> tmp.win <span class="operator">=</span> t.code <span class="keyword">and</span> tmp.ch_ct <span class="operator">=</span> t.ct</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> tmp.ch_name</span><br><span class="line">        <span class="keyword">having</span> c <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">    ) <span class="keyword">as</span> q1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> q1.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> s <span class="keyword">desc</span>, q1.name;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Duckdb</span></span><br><span class="line"><span class="keyword">select</span> q1.name, <span class="built_in">sum</span>(c) <span class="keyword">as</span> s</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(</span><br><span class="line">        <span class="keyword">select</span> tmp.ch_name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> (<span class="keyword">select</span> ch.name <span class="keyword">as</span> ch_name, ch.country_code <span class="keyword">as</span> ch_ct, m.winner_code <span class="keyword">as</span> win <span class="keyword">from</span> coaches <span class="keyword">as</span> ch, medals <span class="keyword">as</span> m <span class="keyword">where</span> ch.discipline <span class="operator">=</span> m.discipline) <span class="keyword">as</span> tmp, athletes <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">where</span> tmp.win <span class="operator">=</span> a.code <span class="keyword">and</span> tmp.ch_ct <span class="operator">=</span> a.country_code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> tmp.ch_name</span><br><span class="line">        <span class="keyword">having</span> c <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> tmp.ch_name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> (<span class="keyword">select</span> ch.name <span class="keyword">as</span> ch_name, ch.country_code <span class="keyword">as</span> ch_ct, m.winner_code <span class="keyword">as</span> win <span class="keyword">from</span> coaches <span class="keyword">as</span> ch, medals <span class="keyword">as</span> m <span class="keyword">where</span> ch.discipline <span class="operator">=</span> m.discipline) <span class="keyword">as</span> tmp, (<span class="keyword">select</span> code, any_value(country_code) <span class="keyword">as</span> ct <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code) <span class="keyword">as</span> t</span><br><span class="line">        <span class="keyword">where</span> tmp.win <span class="operator">=</span> t.code <span class="keyword">and</span> tmp.ch_ct <span class="operator">=</span> t.ct</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> tmp.ch_name</span><br><span class="line">        <span class="keyword">having</span> c <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">    ) <span class="keyword">as</span> q1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> q1.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> s <span class="keyword">desc</span>, q1.name;</span><br></pre></td></tr></table></figure></p></li>
<li><p>查询所有柔道选手的姓名和奖牌数，并按以奖牌数为第一关键字降序、以名字为第二关键字字典序排序</p>
<p>分析：</p>
<p>首先查询所有柔道选手</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name <span class="keyword">from</span> athletes <span class="keyword">where</span> disciplines <span class="operator">=</span> "['Judo']";</span><br></pre></td></tr></table></figure></p>
<p>还有一个很有意思的事情就是 <code>Duckdb</code> 不支持双引号，所以你需要这样写</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name <span class="keyword">from</span> athletes <span class="keyword">where</span> disciplines <span class="operator">=</span> <span class="string">'[''Judo'']'</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后选出所有的柔道奖牌</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> winner_code <span class="keyword">from</span> medals <span class="keyword">where</span> discipline <span class="operator">=</span> <span class="string">'Judo'</span>;</span><br></pre></td></tr></table></figure></p>
<p>选手可能自己拿牌子，也可能通过队伍拿牌子，但是牌子数量是一定的</p>
<p>先算个人拿的牌子</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name, <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">from</span> athletes <span class="keyword">as</span> a, medals <span class="keyword">as</span> m</span><br><span class="line"><span class="keyword">where</span> a.disciplines <span class="operator">=</span> "['Judo']" <span class="keyword">and</span> m.discipline <span class="operator">=</span> <span class="string">'Judo'</span> <span class="keyword">and</span> m.winner_code <span class="operator">=</span> a.code</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.name;</span><br></pre></td></tr></table></figure></p>
<p>再算在队伍中拿的牌子</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name <span class="keyword">as</span> name, t.code <span class="keyword">as</span> t_code</span><br><span class="line"><span class="keyword">from</span> athletes <span class="keyword">as</span> a, teams <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">where</span> a.disciplines <span class="operator">=</span> "['Judo']" <span class="keyword">and</span> a.code <span class="operator">=</span> t.athletes_code;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> p.name, <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">	<span class="keyword">select</span> a.name <span class="keyword">as</span> name, t.code <span class="keyword">as</span> t_code</span><br><span class="line">    <span class="keyword">from</span> athletes <span class="keyword">as</span> a, teams <span class="keyword">as</span> t</span><br><span class="line">    <span class="keyword">where</span> a.disciplines <span class="operator">=</span> "['Judo']" <span class="keyword">and</span> a.code <span class="operator">=</span> t.athletes_code</span><br><span class="line">) <span class="keyword">as</span> p, medals <span class="keyword">as</span> m</span><br><span class="line"><span class="keyword">where</span> p.t_code <span class="operator">=</span> m.winner_code</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> p.name;</span><br></pre></td></tr></table></figure></p>
<p>再合并排序，注意最后要加上奖牌数为 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></svg></mjx-container></span> 的选手</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQLite</span></span><br><span class="line"><span class="keyword">select</span> q2.name, <span class="built_in">sum</span>(c) <span class="keyword">as</span> s</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(</span><br><span class="line">        <span class="keyword">select</span> a.name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> athletes <span class="keyword">as</span> a, medals <span class="keyword">as</span> m</span><br><span class="line">        <span class="keyword">where</span> a.disciplines <span class="operator">=</span> "['Judo']" <span class="keyword">and</span> m.discipline <span class="operator">=</span> <span class="string">'Judo'</span> <span class="keyword">and</span> m.winner_code <span class="operator">=</span> a.code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> a.name</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    	<span class="keyword">select</span> p.name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> (</span><br><span class="line">            <span class="keyword">select</span> a.name <span class="keyword">as</span> name, t.code <span class="keyword">as</span> t_code</span><br><span class="line">            <span class="keyword">from</span> athletes <span class="keyword">as</span> a, teams <span class="keyword">as</span> t</span><br><span class="line">            <span class="keyword">where</span> a.disciplines <span class="operator">=</span> "['Judo']" <span class="keyword">and</span> a.code <span class="operator">=</span> t.athletes_code</span><br><span class="line">        ) <span class="keyword">as</span> p, medals <span class="keyword">as</span> m</span><br><span class="line">        <span class="keyword">where</span> p.t_code <span class="operator">=</span> m.winner_code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> p.name</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> name,<span class="number">0</span> <span class="keyword">from</span> athletes <span class="keyword">where</span> disciplines <span class="operator">=</span> "['Judo']"</span><br><span class="line">	) <span class="keyword">as</span> q2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> q2.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> s <span class="keyword">desc</span>, q2.name;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Duckdb</span></span><br><span class="line"><span class="keyword">select</span> q2.name, <span class="built_in">sum</span>(c) <span class="keyword">as</span> s</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(</span><br><span class="line">        <span class="keyword">select</span> a.name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> athletes <span class="keyword">as</span> a, medals <span class="keyword">as</span> m</span><br><span class="line">        <span class="keyword">where</span> a.disciplines <span class="operator">=</span> <span class="string">'[''Judo'']'</span> <span class="keyword">and</span> m.discipline <span class="operator">=</span> <span class="string">'Judo'</span> <span class="keyword">and</span> m.winner_code <span class="operator">=</span> a.code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> a.name</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    	<span class="keyword">select</span> p.name <span class="keyword">as</span> name, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> (</span><br><span class="line">            <span class="keyword">select</span> a.name <span class="keyword">as</span> name, t.code <span class="keyword">as</span> t_code</span><br><span class="line">            <span class="keyword">from</span> athletes <span class="keyword">as</span> a, teams <span class="keyword">as</span> t</span><br><span class="line">            <span class="keyword">where</span> a.disciplines <span class="operator">=</span> <span class="string">'[''Judo'']'</span> <span class="keyword">and</span> a.code <span class="operator">=</span> t.athletes_code</span><br><span class="line">        ) <span class="keyword">as</span> p, medals <span class="keyword">as</span> m</span><br><span class="line">        <span class="keyword">where</span> p.t_code <span class="operator">=</span> m.winner_code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> p.name</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> name,<span class="number">0</span> <span class="keyword">from</span> athletes <span class="keyword">where</span> disciplines <span class="operator">=</span> <span class="string">'[''Judo'']'</span></span><br><span class="line">	) <span class="keyword">as</span> q2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> q2.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> s <span class="keyword">desc</span>, q2.name;</span><br></pre></td></tr></table></figure></p></li>
<li><p>对于所有举办过田径项目的地点，列出所有在该地点比过赛的运动员，并按以其国籍所在国与代表国之间的距离为第一关键字降序、以名字为第二关键字字典序排序</p>
<p>分析：</p>
<p>先查所有举办过田径项目的地点所对应的比赛结果</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> r.participant_code <span class="keyword">from</span> results <span class="keyword">as</span> r, venues <span class="keyword">as</span> v <span class="keyword">where</span> v.disciplines <span class="keyword">like</span> <span class="string">'%Athletics%'</span> <span class="keyword">and</span> r.venue <span class="operator">=</span> v.venue;</span><br></pre></td></tr></table></figure></p>
<p>再查人（还是分两部分，一部分个人，一部分队伍）</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name <span class="keyword">as</span> ATHLETE_NAME, any_value(a.country_code) <span class="keyword">as</span> REPRESENTED_COUNTRY_CODE, any_value(a.nationality_code) <span class="keyword">as</span> NATIONALITY_COUNTRY_CODE</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> r.participant_code <span class="keyword">as</span> pc</span><br><span class="line">    <span class="keyword">from</span> results <span class="keyword">as</span> r, venues <span class="keyword">as</span> v </span><br><span class="line">    <span class="keyword">where</span> v.disciplines <span class="keyword">like</span> <span class="string">'%Athletics%'</span> <span class="keyword">and</span> r.venue <span class="operator">=</span> v.venue</span><br><span class="line">) <span class="keyword">as</span> rv, athletes <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> rv.pc <span class="operator">=</span> a.code</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.name;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name <span class="keyword">as</span> ATHLETE_NAME, any_value(a.country_code) <span class="keyword">as</span> REPRESENTED_COUNTRY_CODE, any_value(a.nationality_code) <span class="keyword">as</span> NATIONALITY_COUNTRY_CODE</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> r.participant_code <span class="keyword">as</span> pc</span><br><span class="line">    <span class="keyword">from</span> results <span class="keyword">as</span> r, venues <span class="keyword">as</span> v </span><br><span class="line">    <span class="keyword">where</span> v.disciplines <span class="keyword">like</span> <span class="string">'%Athletics%'</span> <span class="keyword">and</span> r.venue <span class="operator">=</span> v.venue</span><br><span class="line">) <span class="keyword">as</span> rv, teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> rv.pc <span class="operator">=</span> t.code <span class="keyword">and</span> t.athletes_code <span class="operator">=</span> a.code</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.name;</span><br></pre></td></tr></table></figure></p>
<p>再排序，有细节，注意只输出经纬度都不为空的数据，正确版本如下</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Duckdb</span></span><br><span class="line"><span class="keyword">with</span> res <span class="keyword">as</span> </span><br><span class="line">(</span><br><span class="line">        <span class="keyword">select</span> a.code, any_value(a.name) <span class="keyword">as</span> ATHLETE_NAME, any_value(a.country_code) <span class="keyword">as</span> REPRESENTED_COUNTRY_CODE, any_value(a.nationality_code) <span class="keyword">as</span> NATIONALITY_COUNTRY_CODE</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> r.participant_code <span class="keyword">as</span> pc</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, venues <span class="keyword">as</span> v </span><br><span class="line">            <span class="keyword">where</span> v.disciplines <span class="keyword">like</span> <span class="string">'%Athletics%'</span> <span class="keyword">and</span> r.venue <span class="operator">=</span> v.venue</span><br><span class="line">        ) <span class="keyword">as</span> rv, athletes <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">where</span> rv.pc <span class="operator">=</span> a.code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> a.code</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.code, any_value(a.name) <span class="keyword">as</span> ATHLETE_NAME, any_value(a.country_code) <span class="keyword">as</span> REPRESENTED_COUNTRY_CODE, any_value(a.nationality_code) <span class="keyword">as</span> NATIONALITY_COUNTRY_CODE</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> r.participant_code <span class="keyword">as</span> pc</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, venues <span class="keyword">as</span> v </span><br><span class="line">            <span class="keyword">where</span> v.disciplines <span class="keyword">like</span> <span class="string">'%Athletics%'</span> <span class="keyword">and</span> r.venue <span class="operator">=</span> v.venue</span><br><span class="line">        ) <span class="keyword">as</span> rv, teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">where</span> rv.pc <span class="operator">=</span> t.code <span class="keyword">and</span> t.athletes_code <span class="operator">=</span> a.code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> a.code</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> res.ATHLETE_NAME, res.REPRESENTED_COUNTRY_CODE, res.NATIONALITY_COUNTRY_CODE</span><br><span class="line"><span class="keyword">from</span> res, countries <span class="keyword">as</span> c1, countries <span class="keyword">as</span> c2</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">(</span><br><span class="line">    res.REPRESENTED_COUNTRY_CODE <span class="operator">=</span> c1.code <span class="keyword">and</span> </span><br><span class="line">    res.NATIONALITY_COUNTRY_CODE <span class="operator">=</span> c2.code <span class="keyword">and</span></span><br><span class="line">    c1.Latitude <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">    c2.Latitude <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">    c1.Longitude <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">    c2.Longitude <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> ((c1.Latitude<span class="operator">-</span>c2.Latitude)<span class="operator">*</span>(c1.Latitude<span class="operator">-</span>c2.Latitude)<span class="operator">+</span>(c1.Longitude<span class="operator">-</span>c2.Longitude)<span class="operator">*</span>(c1.Longitude<span class="operator">-</span>c2.Longitude)) <span class="keyword">desc</span>, res.ATHLETE_NAME;</span><br></pre></td></tr></table></figure></p>
<p>在之前我犯了一个错误出现了如下的结果</p>
<p>Std:</p>
<p><img src="https://p.ipic.vip/sxik4g.png" alt="image-20250111075602898" style="zoom:50%;"></p>
<p>My:</p>
<p><img src="https://p.ipic.vip/vhae0x.png" alt="image-20250111075649255" style="zoom:50%;"></p>
<p>怎么活？</p>
<p>排查结果是，有一个重名的选手，也就是名字一样但编号不一样，<code>union</code> 的时候我没输出编号，只输出了名字，所以 <code>union</code> 语句自己给去重了，警钟长鸣</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQLite</span></span><br><span class="line"><span class="keyword">with</span> res <span class="keyword">as</span> </span><br><span class="line">(</span><br><span class="line">        <span class="keyword">select</span> a.code, a.name <span class="keyword">as</span> ATHLETE_NAME, a.country_code <span class="keyword">as</span> REPRESENTED_COUNTRY_CODE, a.nationality_code <span class="keyword">as</span> NATIONALITY_COUNTRY_CODE</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> r.participant_code <span class="keyword">as</span> pc</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, venues <span class="keyword">as</span> v </span><br><span class="line">            <span class="keyword">where</span> v.disciplines <span class="keyword">like</span> <span class="string">'%Athletics%'</span> <span class="keyword">and</span> r.venue <span class="operator">=</span> v.venue</span><br><span class="line">        ) <span class="keyword">as</span> rv, athletes <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">where</span> rv.pc <span class="operator">=</span> a.code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> a.code</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.code, a.name <span class="keyword">as</span> ATHLETE_NAME, a.country_code <span class="keyword">as</span> REPRESENTED_COUNTRY_CODE, a.nationality_code <span class="keyword">as</span> NATIONALITY_COUNTRY_CODE</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> r.participant_code <span class="keyword">as</span> pc</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, venues <span class="keyword">as</span> v </span><br><span class="line">            <span class="keyword">where</span> v.disciplines <span class="keyword">like</span> <span class="string">'%Athletics%'</span> <span class="keyword">and</span> r.venue <span class="operator">=</span> v.venue</span><br><span class="line">        ) <span class="keyword">as</span> rv, teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">where</span> rv.pc <span class="operator">=</span> t.code <span class="keyword">and</span> t.athletes_code <span class="operator">=</span> a.code</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> a.code</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> res.ATHLETE_NAME, res.REPRESENTED_COUNTRY_CODE, res.NATIONALITY_COUNTRY_CODE</span><br><span class="line"><span class="keyword">from</span> res, countries <span class="keyword">as</span> c1, countries <span class="keyword">as</span> c2</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">(</span><br><span class="line">    res.REPRESENTED_COUNTRY_CODE <span class="operator">=</span> c1.code <span class="keyword">and</span> </span><br><span class="line">    res.NATIONALITY_COUNTRY_CODE <span class="operator">=</span> c2.code <span class="keyword">and</span></span><br><span class="line">    c1.Latitude <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">    c2.Latitude <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">    c1.Longitude <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">    c2.Longitude <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> ((c1.Latitude<span class="operator">-</span>c2.Latitude)<span class="operator">*</span>(c1.Latitude<span class="operator">-</span>c2.Latitude)<span class="operator">+</span>(c1.Longitude<span class="operator">-</span>c2.Longitude)<span class="operator">*</span>(c1.Longitude<span class="operator">-</span>c2.Longitude)) <span class="keyword">desc</span>, res.ATHLETE_NAME;</span><br></pre></td></tr></table></figure></p></li>
<li><p>对于每一天，找到当天在前五名（包括）中出现次数最多的国家，同时列出其人口排名和 GDP 排名，并按日期升序排序</p>
<p>分析：</p>
<p>先查每一天各个国家在前五名的记录，注意这里是 <code>union all</code></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, a.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">    <span class="keyword">from</span> results <span class="keyword">as</span> r, athletes <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">where</span> r.participant_code <span class="operator">=</span> a.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">	<span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, t.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">	<span class="keyword">from</span> results <span class="keyword">as</span> r, (<span class="keyword">select</span> teams.code <span class="keyword">as</span> code, any_value(teams.country_code) <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> teams.code) <span class="keyword">as</span> t</span><br><span class="line">	<span class="keyword">where</span> r.participant_code <span class="operator">=</span> t.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span>;</span><br></pre></td></tr></table></figure></p>
<p>再通过横向查询算出每天各个国家在前五名中出现的次数</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tms <span class="keyword">as</span> </span><br><span class="line">(</span><br><span class="line">	<span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, a.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">    <span class="keyword">from</span> results <span class="keyword">as</span> r, athletes <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">where</span> r.participant_code <span class="operator">=</span> a.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">	<span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">	<span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, t.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">	<span class="keyword">from</span> results <span class="keyword">as</span> r, (<span class="keyword">select</span> teams.code <span class="keyword">as</span> code, any_value(teams.country_code) <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> teams.code) <span class="keyword">as</span> t</span><br><span class="line">	<span class="keyword">where</span> r.participant_code <span class="operator">=</span> t.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> t1.date, t1.country_code, times.c</span><br><span class="line"><span class="keyword">from</span> tms <span class="keyword">as</span> t1, </span><br><span class="line">	<span class="keyword">lateral</span> </span><br><span class="line">	(</span><br><span class="line">        <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> tms <span class="keyword">as</span> t2</span><br><span class="line">        <span class="keyword">where</span> t2.date <span class="operator">=</span> t1.date <span class="keyword">and</span> t2.country_code <span class="operator">=</span> t1.country_code</span><br><span class="line">	) <span class="keyword">as</span> times</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> t1.date <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure></p>
<p>利用窗口函数得到每天次数最大的一个 tuple</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> max_t <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        <span class="operator">*</span>, </span><br><span class="line">        <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> mdt.date <span class="keyword">order</span> <span class="keyword">by</span> mdt.c <span class="keyword">desc</span>, mdt.country_code) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">with</span> tms <span class="keyword">as</span> </span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, a.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, athletes <span class="keyword">as</span> a</span><br><span class="line">            <span class="keyword">where</span> r.participant_code <span class="operator">=</span> a.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">            <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">            <span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, t.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, (<span class="keyword">select</span> teams.code <span class="keyword">as</span> code, any_value(teams.country_code) <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> teams.code) <span class="keyword">as</span> t</span><br><span class="line">            <span class="keyword">where</span> r.participant_code <span class="operator">=</span> t.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">distinct</span> t1.date <span class="keyword">as</span> <span class="type">date</span>, t1.country_code <span class="keyword">as</span> country_code, times.c <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> tms <span class="keyword">as</span> t1, </span><br><span class="line">            <span class="keyword">lateral</span> </span><br><span class="line">            (</span><br><span class="line">                <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">                <span class="keyword">from</span> tms <span class="keyword">as</span> t2</span><br><span class="line">                <span class="keyword">where</span> t2.date <span class="operator">=</span> t1.date <span class="keyword">and</span> t2.country_code <span class="operator">=</span> t1.country_code</span><br><span class="line">            ) <span class="keyword">as</span> times</span><br><span class="line">    ) <span class="keyword">as</span> mdt</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> m.date, m.country_code, m.c</span><br><span class="line"><span class="keyword">from</span> max_t <span class="keyword">as</span> m</span><br><span class="line"><span class="keyword">where</span> rk <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> m.date <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure></p>
<p>查询 GDP_rank 和 populartion_rank</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	code,  </span><br><span class="line">	<span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> Population <span class="keyword">desc</span>) <span class="keyword">as</span> rk_pop, </span><br><span class="line">	<span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> "GDP ($ per capita)" <span class="keyword">desc</span>) <span class="keyword">as</span> rk_GDP</span><br><span class="line"><span class="keyword">from</span> countries</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">	"GDP ($ per capita)" <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">	Population <span class="keyword">is</span> <span class="keyword">not null</span>;</span><br></pre></td></tr></table></figure></p>
<p>合并！排序！</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Duckdb</span></span><br><span class="line"><span class="keyword">with</span> max_t <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        <span class="operator">*</span>, </span><br><span class="line">        <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> mdt.date <span class="keyword">order</span> <span class="keyword">by</span> mdt.c <span class="keyword">desc</span>, mdt.country_code) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">with</span> tms <span class="keyword">as</span> </span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, a.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, athletes <span class="keyword">as</span> a</span><br><span class="line">            <span class="keyword">where</span> r.participant_code <span class="operator">=</span> a.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">            <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">            <span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, t.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, (<span class="keyword">select</span> teams.code <span class="keyword">as</span> code, any_value(teams.country_code) <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> teams.code) <span class="keyword">as</span> t</span><br><span class="line">            <span class="keyword">where</span> r.participant_code <span class="operator">=</span> t.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">distinct</span> t1.date <span class="keyword">as</span> <span class="type">date</span>, t1.country_code <span class="keyword">as</span> country_code, times.c <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> tms <span class="keyword">as</span> t1, </span><br><span class="line">            <span class="keyword">lateral</span> </span><br><span class="line">            (</span><br><span class="line">                <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">                <span class="keyword">from</span> tms <span class="keyword">as</span> t2</span><br><span class="line">                <span class="keyword">where</span> t2.date <span class="operator">=</span> t1.date <span class="keyword">and</span> t2.country_code <span class="operator">=</span> t1.country_code</span><br><span class="line">            ) <span class="keyword">as</span> times</span><br><span class="line">    ) <span class="keyword">as</span> mdt</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> m.date <span class="keyword">as</span> <span class="type">date</span>, m.country_code <span class="keyword">as</span> country_code, m.c <span class="keyword">as</span> top5_appearances, ct_info.rk_GDP <span class="keyword">as</span> gdp_rank, ct_info.rk_pop <span class="keyword">as</span> population_rank</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	max_t <span class="keyword">as</span> m, </span><br><span class="line">	(</span><br><span class="line">    	<span class="keyword">select</span> </span><br><span class="line">            code,  </span><br><span class="line">            <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> Population <span class="keyword">desc</span>) <span class="keyword">as</span> rk_pop, </span><br><span class="line">            <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> "GDP ($ per capita)" <span class="keyword">desc</span>) <span class="keyword">as</span> rk_GDP</span><br><span class="line">        <span class="keyword">from</span> countries</span><br><span class="line">        <span class="keyword">where</span> </span><br><span class="line">            "GDP ($ per capita)" <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">            Population <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">    ) <span class="keyword">as</span> ct_info</span><br><span class="line"><span class="keyword">where</span> rk <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> ct_info.code <span class="operator">=</span> m.country_code</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> m.date <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure></p>
<p><code>SQLite</code> 不支持横向查询 <code>lateral</code> 关键字</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQLite</span></span><br><span class="line"><span class="keyword">with</span> max_t <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        <span class="operator">*</span>, </span><br><span class="line">        <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> mdt.date <span class="keyword">order</span> <span class="keyword">by</span> mdt.c <span class="keyword">desc</span>, mdt.country_code) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">with</span> tms <span class="keyword">as</span> </span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, a.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, athletes <span class="keyword">as</span> a</span><br><span class="line">            <span class="keyword">where</span> r.participant_code <span class="operator">=</span> a.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">            <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">            <span class="keyword">select</span> r.date <span class="keyword">as</span> <span class="type">date</span>, t.country_code <span class="keyword">as</span> country_code, r.rank</span><br><span class="line">            <span class="keyword">from</span> results <span class="keyword">as</span> r, (<span class="keyword">select</span> teams.code <span class="keyword">as</span> code, teams.country_code <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> teams.code) <span class="keyword">as</span> t</span><br><span class="line">            <span class="keyword">where</span> r.participant_code <span class="operator">=</span> t.code <span class="keyword">and</span> r.rank <span class="operator">&lt;=</span> <span class="number">5</span> <span class="keyword">and</span> r.rank <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">distinct</span> t1.date <span class="keyword">as</span> <span class="type">date</span>, t1.country_code <span class="keyword">as</span> country_code, times.c <span class="keyword">as</span> c</span><br><span class="line">        <span class="keyword">from</span> tms <span class="keyword">as</span> t1</span><br><span class="line">        <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">       	(</span><br><span class="line">        	<span class="keyword">select</span> t2.date, t2.country_code, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c</span><br><span class="line">            <span class="keyword">from</span> tms <span class="keyword">as</span> t2</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> t2.date, t2.country_code</span><br><span class="line">        ) <span class="keyword">as</span> times</span><br><span class="line">        <span class="keyword">on</span> t1.date <span class="operator">=</span> times.date <span class="keyword">and</span> t1.country_code <span class="operator">=</span> times.country_code</span><br><span class="line">    ) <span class="keyword">as</span> mdt</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> m.date <span class="keyword">as</span> <span class="type">date</span>, m.country_code <span class="keyword">as</span> country_code, m.c <span class="keyword">as</span> top5_appearances, ct_info.rk_GDP <span class="keyword">as</span> gdp_rank, ct_info.rk_pop <span class="keyword">as</span> population_rank</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	max_t <span class="keyword">as</span> m, </span><br><span class="line">	(</span><br><span class="line">    	<span class="keyword">select</span> </span><br><span class="line">            code,  </span><br><span class="line">            <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> Population <span class="keyword">desc</span>) <span class="keyword">as</span> rk_pop, </span><br><span class="line">            <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> "GDP ($ per capita)" <span class="keyword">desc</span>) <span class="keyword">as</span> rk_GDP</span><br><span class="line">        <span class="keyword">from</span> countries</span><br><span class="line">        <span class="keyword">where</span> </span><br><span class="line">            "GDP ($ per capita)" <span class="keyword">is</span> <span class="keyword">not null</span> <span class="keyword">and</span></span><br><span class="line">            Population <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">    ) <span class="keyword">as</span> ct_info</span><br><span class="line"><span class="keyword">where</span> rk <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> ct_info.code <span class="operator">=</span> m.country_code</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> m.date <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure></p></li>
<li><p>对比于东京奥运会，列出在金牌数量上有最大进步的五个国家，对于这五个国家，列出所属所有全女生的队伍，并按以提升的金牌数为第一关键字降序、以国家 code 为第二关键字字典序、以队伍 code 为第三关键字字典序排序</p>
<p>分析：</p>
<p>先查出所有国家的金牌数量</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s1.cc, <span class="built_in">sum</span>(s)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">    <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, athletes <span class="keyword">as</span> a, medal_info <span class="keyword">as</span> mi</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">    	m.winner_code <span class="operator">=</span> a.code <span class="keyword">and</span> </span><br><span class="line">    	a.country_code <span class="operator">=</span> c.code <span class="keyword">and</span> </span><br><span class="line">    	mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span> </span><br><span class="line">    	mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">    <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, (<span class="keyword">select</span> code, any_value(country_code) <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code) <span class="keyword">as</span> t, medal_info <span class="keyword">as</span> mi</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">	m.winner_code <span class="operator">=</span> t.code <span class="keyword">and</span> </span><br><span class="line">    	t.country_code <span class="operator">=</span> c.code <span class="keyword">and</span></span><br><span class="line">	mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span></span><br><span class="line">    	mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">) <span class="keyword">as</span> s1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> cc;</span><br></pre></td></tr></table></figure></p>
<p>再查出所有国家进步的金牌数量，以及前五</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	s1.cc, </span><br><span class="line">	(<span class="built_in">sum</span>(s)<span class="operator">-</span>any_value(tm.gold_medal)) <span class="keyword">as</span> increased_gold_medal_number, </span><br><span class="line">	<span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> increased_gold_medal_number <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">    <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, athletes <span class="keyword">as</span> a, medal_info <span class="keyword">as</span> mi</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    	m.winner_code <span class="operator">=</span> a.code <span class="keyword">and</span> </span><br><span class="line">    	a.country_code <span class="operator">=</span> c.code <span class="keyword">and</span> </span><br><span class="line">    	mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span> </span><br><span class="line">    	mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">    <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, (<span class="keyword">select</span> code, any_value(country_code) <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code) <span class="keyword">as</span> t, medal_info <span class="keyword">as</span> mi</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">    	m.winner_code <span class="operator">=</span> t.code <span class="keyword">and</span> </span><br><span class="line">    	t.country_code <span class="operator">=</span> c.code <span class="keyword">and</span></span><br><span class="line">    	mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span></span><br><span class="line">    	mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">) <span class="keyword">as</span> s1 <span class="keyword">left</span> <span class="keyword">join</span> tokyo_medals <span class="keyword">as</span> tm</span><br><span class="line"><span class="keyword">on</span> s1.cc <span class="operator">=</span> tm.country_code</span><br><span class="line"><span class="keyword">where</span> tm.gold_medal <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> cc</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> rk</span><br><span class="line">limit <span class="number">5</span>;</span><br></pre></td></tr></table></figure></p>
<p>找全女队</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> sm1 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> t.code <span class="keyword">as</span> code, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c, any_value(t.country_code) <span class="keyword">as</span> cc</span><br><span class="line">    <span class="keyword">from</span> teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">where</span> t.athletes_code <span class="operator">=</span> a.code</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> t.code</span><br><span class="line">),</span><br><span class="line">sm2 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> t.code <span class="keyword">as</span> code, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c, any_value(t.country_code) <span class="keyword">as</span> cc</span><br><span class="line">    <span class="keyword">from</span> teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a, gender <span class="keyword">as</span> g</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        t.athletes_code <span class="operator">=</span> a.code <span class="keyword">and</span> </span><br><span class="line">        a.gender <span class="operator">=</span> g.id <span class="keyword">and</span> </span><br><span class="line">        g.name <span class="operator">=</span> <span class="string">'Female'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> t.code</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> sm1.cc, sm1.code</span><br><span class="line"><span class="keyword">from</span> sm1, sm2</span><br><span class="line"><span class="keyword">where</span> sm1.code <span class="operator">=</span> sm2.code <span class="keyword">and</span> sm1.c <span class="operator">=</span> sm2.c;</span><br></pre></td></tr></table></figure></p>
<p>合并！排序！</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Duckdb</span></span><br><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        s1.cc, </span><br><span class="line">        (<span class="built_in">sum</span>(s)<span class="operator">-</span>any_value(tm.gold_medal)) <span class="keyword">as</span> increased_gold_medal_number, </span><br><span class="line">        <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> increased_gold_medal_number <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">        <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, athletes <span class="keyword">as</span> a, medal_info <span class="keyword">as</span> mi</span><br><span class="line">        <span class="keyword">where</span> </span><br><span class="line">            m.winner_code <span class="operator">=</span> a.code <span class="keyword">and</span> </span><br><span class="line">            a.country_code <span class="operator">=</span> c.code <span class="keyword">and</span> </span><br><span class="line">            mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span> </span><br><span class="line">            mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">        <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, (<span class="keyword">select</span> code, any_value(country_code) <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code) <span class="keyword">as</span> t, medal_info <span class="keyword">as</span> mi</span><br><span class="line">        <span class="keyword">where</span> </span><br><span class="line">            m.winner_code <span class="operator">=</span> t.code <span class="keyword">and</span> </span><br><span class="line">            t.country_code <span class="operator">=</span> c.code <span class="keyword">and</span></span><br><span class="line">            mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span></span><br><span class="line">            mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">    ) <span class="keyword">as</span> s1 <span class="keyword">left</span> <span class="keyword">join</span> tokyo_medals <span class="keyword">as</span> tm</span><br><span class="line">    <span class="keyword">on</span> s1.cc <span class="operator">=</span> tm.country_code</span><br><span class="line">    <span class="keyword">where</span> tm.gold_medal <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> cc</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> rk</span><br><span class="line">    limit <span class="number">5</span></span><br><span class="line">),</span><br><span class="line">sm1 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> t.code <span class="keyword">as</span> code, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c, any_value(t.country_code) <span class="keyword">as</span> cc</span><br><span class="line">    <span class="keyword">from</span> teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">where</span> t.athletes_code <span class="operator">=</span> a.code</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> t.code</span><br><span class="line">),</span><br><span class="line">sm2 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> t.code <span class="keyword">as</span> code, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c, any_value(t.country_code) <span class="keyword">as</span> cc</span><br><span class="line">    <span class="keyword">from</span> teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a, gender <span class="keyword">as</span> g</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        t.athletes_code <span class="operator">=</span> a.code <span class="keyword">and</span> </span><br><span class="line">        a.gender <span class="operator">=</span> g.id <span class="keyword">and</span> </span><br><span class="line">        g.name <span class="operator">=</span> <span class="string">'Female'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> t.code</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> tmp.cc <span class="keyword">as</span> country_code, tmp.increased_gold_medal_number <span class="keyword">as</span> increased_gold_medal_number, sm1.code <span class="keyword">as</span> team_code</span><br><span class="line"><span class="keyword">from</span> sm1, sm2, tmp</span><br><span class="line"><span class="keyword">where</span> tmp.cc <span class="operator">=</span> sm1.cc <span class="keyword">and</span> sm1.code <span class="operator">=</span> sm2.code <span class="keyword">and</span> sm1.c <span class="operator">=</span> sm2.c</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> increased_gold_medal_number <span class="keyword">desc</span>, country_code, team_code;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQLite</span></span><br><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        s1.cc, </span><br><span class="line">        (<span class="built_in">sum</span>(s)<span class="operator">-</span>tm.gold_medal) <span class="keyword">as</span> increased_gold_medal_number, </span><br><span class="line">        <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> (<span class="built_in">sum</span>(s)<span class="operator">-</span>tm.gold_medal) <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">        <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, athletes <span class="keyword">as</span> a, medal_info <span class="keyword">as</span> mi</span><br><span class="line">        <span class="keyword">where</span> </span><br><span class="line">            m.winner_code <span class="operator">=</span> a.code <span class="keyword">and</span> </span><br><span class="line">            a.country_code <span class="operator">=</span> c.code <span class="keyword">and</span> </span><br><span class="line">            mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span> </span><br><span class="line">            mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> c.code <span class="keyword">as</span> cc, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> s</span><br><span class="line">        <span class="keyword">from</span> medals <span class="keyword">as</span> m, countries <span class="keyword">as</span> c, (<span class="keyword">select</span> code, country_code <span class="keyword">as</span> country_code <span class="keyword">from</span> teams <span class="keyword">group</span> <span class="keyword">by</span> code) <span class="keyword">as</span> t, medal_info <span class="keyword">as</span> mi</span><br><span class="line">        <span class="keyword">where</span> </span><br><span class="line">            m.winner_code <span class="operator">=</span> t.code <span class="keyword">and</span> </span><br><span class="line">            t.country_code <span class="operator">=</span> c.code <span class="keyword">and</span></span><br><span class="line">            mi.code <span class="operator">=</span> m.medal_code <span class="keyword">and</span></span><br><span class="line">            mi.name <span class="operator">=</span> <span class="string">'Gold Medal'</span></span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> c.code</span><br><span class="line">    ) <span class="keyword">as</span> s1 <span class="keyword">left</span> <span class="keyword">join</span> tokyo_medals <span class="keyword">as</span> tm</span><br><span class="line">    <span class="keyword">on</span> s1.cc <span class="operator">=</span> tm.country_code</span><br><span class="line">    <span class="keyword">where</span> tm.gold_medal <span class="keyword">is</span> <span class="keyword">not null</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> cc</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> rk</span><br><span class="line">    limit <span class="number">5</span></span><br><span class="line">),</span><br><span class="line">sm1 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> t.code <span class="keyword">as</span> code, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c, t.country_code <span class="keyword">as</span> cc</span><br><span class="line">    <span class="keyword">from</span> teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">where</span> t.athletes_code <span class="operator">=</span> a.code</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> t.code</span><br><span class="line">),</span><br><span class="line">sm2 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> t.code <span class="keyword">as</span> code, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c, t.country_code <span class="keyword">as</span> cc</span><br><span class="line">    <span class="keyword">from</span> teams <span class="keyword">as</span> t, athletes <span class="keyword">as</span> a, gender <span class="keyword">as</span> g</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        t.athletes_code <span class="operator">=</span> a.code <span class="keyword">and</span> </span><br><span class="line">        a.gender <span class="operator">=</span> g.id <span class="keyword">and</span> </span><br><span class="line">        g.name <span class="operator">=</span> <span class="string">'Female'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> t.code</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> tmp.cc <span class="keyword">as</span> country_code, tmp.increased_gold_medal_number <span class="keyword">as</span> increased_gold_medal_number, sm1.code <span class="keyword">as</span> team_code</span><br><span class="line"><span class="keyword">from</span> sm1, sm2, tmp</span><br><span class="line"><span class="keyword">where</span> tmp.cc <span class="operator">=</span> sm1.cc <span class="keyword">and</span> sm1.code <span class="operator">=</span> sm2.code <span class="keyword">and</span> sm1.c <span class="operator">=</span> sm2.c</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> increased_gold_medal_number <span class="keyword">desc</span>, country_code, team_code;</span><br></pre></td></tr></table></figure></p></li>
</ol>
<hr>
<h2 id="lecture-03---database-storage-i">Lecture #03 - Database Storage I</h2>
<p><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/fall2024/notes/03-storage1.pdf">Notes</a></p>
<p>Andy 教授说话太快了 T_T</p>
<p>focus on Disk-oriented DBMS</p>
<p><img src="https://p.ipic.vip/2z04uj.png" alt="image-20250111144703544" style="zoom:80%;"></p>
<p>这个机制很像 OS 中的 Virtual Memory 的实现，Buffer Pool 类似 TLB</p>
<p>本节主要讨论 DBMS 如何在磁盘文件中组织数据</p>
<ol type="1">
<li><p>The DBMS stores a databases as one or more files on disk typically in a proprietary format</p></li>
<li><p>the storage manager 负责将数据以页面的形式组织在文件中，同时追踪数据读写和可用空间，通常不建立和维护页面副本</p></li>
<li><p>数据（tuples, meta-data, indexes, log records...）在文件中以 pages 的形式被存储</p>
<ul>
<li><p>有些 DBMS 要求页面 self-contained (e.g., Oracle)，原因是在 disaster recovery 时可以恢复尽可能多的数据</p></li>
<li><p>每个页有唯一的 page ID 便于检索，the DBMS uses an indirection layer to map page IDs to physical locations</p></li>
<li><p>三种 page：Hardware Page (usually 4KB), OS Page (usually 4KB, x64 2MB/1GB), Database Page (512B-32KB)</p></li>
<li><p>A hardware page is the largest block of data that the storage device can guarantee failsafe writes</p></li>
</ul></li>
<li><p>大部分 DBMSs 以 Heap File Organization 的方式组织文件中的 pages</p>
<ul>
<li><p>A heap file is an unordered collection of pages with tuples that are stored in random order.</p>
<p><img src="https://p.ipic.vip/5fblb5.png" alt="image-20250112021218141" style="zoom:80%;"></p></li>
</ul></li>
<li><p>Every page contains a header of meta-data about the page's contents (e.g., page size, checksum, DBMS version, transaction visibility, compression/encoding meta-data, schema information, data summary/sketches)</p></li>
<li><p>页面中组织数据三种方式：Tuple-oriented Storage, Log-structured Storage, Index-organized Storage</p></li>
<li><p>Tuple-oriented Storage 的一种普遍的实现方式：slotted pages</p>
<p><img src="https://p.ipic.vip/qm12mh.png" alt="image-20250112030826236" style="zoom:80%;"></p>
<ul>
<li>插入一个新元组：
<ul>
<li>检查 page directory 找到一个有 free slot 的 page</li>
<li>如果不在内存中的话从磁盘中检索该 page</li>
<li>检查 slot array 找到可以盛下的空位</li>
</ul></li>
<li>利用 Record ID 更新已有的元组:
<ul>
<li>检查 page directory 找到 page 位置</li>
<li>如果不在内存中的话从磁盘中检索该 page</li>
<li>检查 slot array 找到偏移量</li>
<li>如果新数据可以盛下就覆盖原有数据，否则把原有数据标记删除，在新页面插入一个新版本</li>
</ul></li>
</ul></li>
<li><p>Record IDs: The DBMS assigns each logical tuple a unique record identifier that that represents its physical location in the database (but shouldn't be relied on to fetch data)</p></li>
</ol>
<p>最后 tuple layout 的部分 Andy 教授没有讲完，有一些疑惑问了 ChatGPT，记录一下</p>
<ol start="9" type="1">
<li>A tuple is essentially a sequence of bytes. <strong>These bytes do not have to be contiguous.</strong> 这个下一节的 <code>large value</code> 会提到</li>
<li>tuple 存储的时候也有自己的 header，主要存储 Visibility info（事务信息，支持并发控制）和 Null Bitmap（空值位图），不存储每个 attribute 的类型，这个下一节的 <code>system catalogs</code> 会提到</li>
<li>Denormalize: If two tables are related, the DBMS can "pre-join" them, so the tables end up on the same page. This makes reads faster since the DBMS only has to load in one page rather than two separate pages. However, it makes updates more expensive since the DBMS needs more space for each tuple</li>
</ol>
<hr>
<h2 id="lecture-04---database-storage-ii">Lecture #04 - Database Storage II</h2>
<p><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/fall2024/notes/04-storage2.pdf">Notes</a></p>
<h3 id="log-structured-storage">Log-Structured Storage</h3>
<p>查询/修改过程：</p>
<p><img src="https://p.ipic.vip/fsm2r4.png" alt="image-20250112062356080" style="zoom:80%;"></p>
<p><img src="https://p.ipic.vip/v4hnac.png" alt="image-20250112062425849" style="zoom:80%;"></p>
<p>SummaryTable 会告诉你你要找的数据在不在某一个 level</p>
<p><img src="https://p.ipic.vip/eq4xv1.png" alt="image-20250112064529446" style="zoom:80%;"></p>
<p>SSTables 的压缩过程：</p>
<p><img src="https://p.ipic.vip/25wsoa.png" alt="image-20250112065519014" style="zoom:80%;"></p>
<p>缺点：</p>
<ul>
<li>写放大（Write-Amplification）：在一个写操作后，这个操作会被重写若干次</li>
<li>压缩成本高（Compaction is expensive）</li>
</ul>
<p>Ideal for write-heavy workloads because it maximizes sequential disk I/O</p>
<h3 id="index-organized-storage">Index-Organized Storage</h3>
<p>B+树为例</p>
<p><img src="https://p.ipic.vip/n9yx03.png" alt="image-20250112070825294" style="zoom:80%;"></p>
<h3 id="tuple-storage">Tuple Storage</h3>
<ol type="1">
<li>Data 只是一些 bytes，类型甚至是 unsigned char*，我们需要 <code>reinterpret_cast&lt;int32_t*&gt;(address)</code> （在C++中）</li>
<li>为了使查询快速，我们要保证 tuple 的属性值是字节对齐的</li>
<li>不一样的属性顺序排序可能会影响存储 tuple 的大小</li>
</ol>
<h3 id="data-representation">Data Representation</h3>
<ol type="1">
<li><p>单/双精度会有 rounding error，如果不能接受，使用 fixed precision numbers，如 numeric 和 decimal</p></li>
<li><p>NULL Data Types</p>
<ul>
<li>Row-stores: Null Column Bitmap Header</li>
<li>Column-stores: Special Valuew</li>
<li>Per Attribute Null Flag，会打乱对齐，不建议</li>
</ul></li>
<li><p>处理 large values</p>
<p>如果一个值需要的存储空间大于一个页了，DBMS 会将其存储在 overflow storage pages</p>
<p><img src="https://p.ipic.vip/1ehuqg.png" alt="image-20250113230311835" style="zoom:80%;"></p>
<p>一些系统允许把 large value 存在外部文件里，类型为 BLOB，但是 DBMS 就管不了了</p></li>
</ol>
<hr>
<h2 id="project-1---buffer-pool-manager">Project #1 - Buffer Pool Manager</h2>
<hr>
<h2 id="lecture-05--">Lecture #05 -</h2>
<hr>
<h2 id="homework-2--">Homework #2 -</h2>
<hr>

    </div>

    
    <div class="about">
        <h1>关于本文</h1>
        <div class="details">
            <p>由 wsy_jim 撰写, 采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a> 许可协议.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CMU/" class="tag">#CMU</a><a href="/tags/Databases/" class="tag">#Databases</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/12/27/better-terminal/" class="next">
            <div>
                <div class="text">
                    <p class="label">下一篇</p>
                    <h3 class="title">更好的终端模组</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/12/04/Mysql-learning-2/" class="prev">
            <div>
                <div class="text">
                    <p class="label">上一篇</p>
                    <h3 class="title">MySQL 学习笔记进阶篇</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="wsyunine/blog_comments" data-repo-id="R_kgDON37drA" data-category="Announcements" data-category-id="DIC_kwDON37drM4Cm5_n" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async> </script>
        
    
</article>


        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/guestbook" class="item">Guestbook</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/wsyunine" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/wsy_jim" class="item">Discord</a>
                
                <a href="mailto:3340307001@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 wsy_jim<br>由 <a href="http://hexo.io/" target="_blank">Hexo</a> 驱动 </span>
        
        <br>
        <span class="footer-extra-description">玄之又玄，众妙之门。</span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>

    <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("Lenis script loaded!");
        
        const lenis = new Lenis({
            smooth: true,
            lerp: 0.1,
            wheelMultiplier: 1,
            touchMultiplier: 2,
            infinite: false
        });

        function raf(time) {
            lenis.raf(time);
            requestAnimationFrame(raf);
        }

        requestAnimationFrame(raf);
    });
    </script>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>